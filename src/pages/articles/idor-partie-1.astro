---
import Layout from '../../layouts/Layout.astro';
import IDORMethodDiagram from '../../components/diagrams/IDORMethodDiagram.astro';
import { marked } from 'marked';
import hljs from 'highlight.js';
import fs from 'fs';
import path from 'path';

const article = {
  title: "IDOR : La m√©thode qui marche",
  description: "La m√©thode 2-comptes, le setup qui marche, et les r√®gles du jeu pour tester les IDOR proprement.",
  date: "2026-02-07",
  tags: ["IDOR", "Bug Bounty", "1/3"],
  readingTime: "10 min"
};

const formattedDate = new Date(article.date).toLocaleDateString('fr-FR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Read the markdown file
const contentPath = path.join(process.cwd(), 'src', 'content', 'articles', 'idor-partie-1.md');
let mdContent = '';
try {
  mdContent = fs.readFileSync(contentPath, 'utf-8');
} catch {
  mdContent = `# ${article.title}\n\nContenu √† venir...`;
}

// Extract headings for TOC
function slugify(text: string): string {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

interface TocItem {
  level: number;
  text: string;
  slug: string;
}

const tocItems: TocItem[] = [];
const headingRegex = /^(#{2,3})\s+(.+)$/gm;
let match;
while ((match = headingRegex.exec(mdContent)) !== null) {
  const level = match[1].length;
  const text = match[2].trim();
  tocItems.push({
    level,
    text,
    slug: slugify(text)
  });
}

// Custom renderer to add IDs to headings, syntax highlighting, and style callouts
const renderer = new marked.Renderer();

renderer.code = function({ text, lang }) {
  const language = lang && hljs.getLanguage(lang) ? lang : 'plaintext';
  const highlighted = hljs.highlight(text, { language }).value;
  return `<pre><code class="hljs language-${language}">${highlighted}</code></pre>`;
};

renderer.heading = function({ tokens, depth }) {
  const text = tokens.map(t => t.raw).join('');
  const slug = slugify(text);
  return `<h${depth} id="${slug}">${text}</h${depth}>`;
};

renderer.blockquote = function({ raw, text }) {
  // Check for callout syntax: > [!TYPE]\n> content
  const calloutMatch = text.match(/^\s*\[!(TIP|WARNING|INFO|NOTE)\]\s*([\s\S]*)/i);
  if (calloutMatch) {
    const type = calloutMatch[1].toLowerCase();
    const content = calloutMatch[2].trim();
    const icons: Record<string, string> = {
      tip: 'üí°',
      warning: '‚ö†Ô∏è',
      info: '‚ÑπÔ∏è',
      note: 'üìù'
    };
    const titles: Record<string, string> = {
      tip: 'Tip',
      warning: 'Attention',
      info: 'Info',
      note: 'Note'
    };
    return `<div class="callout callout-${type}">
      <div class="callout-title">${icons[type]} ${titles[type]}</div>
      <div class="callout-content">${marked.parse(content)}</div>
    </div>`;
  }
  return `<blockquote>${text}</blockquote>`;
};

marked.use({ renderer });

// Split content at diagram marker
const DIAGRAM_MARKER = '<!-- DIAGRAM:method -->';
const [contentBefore, contentAfter] = mdContent.split(DIAGRAM_MARKER);
const htmlBefore = marked.parse(contentBefore);
const htmlAfter = contentAfter ? marked.parse(contentAfter) : '';
---

<Layout title={article.title} description={article.description}>
  <div class="article-layout">
    <!-- TOC Sidebar -->
    <aside class="toc-sidebar">
      <nav class="toc-nav">
        <div class="toc-title">Table des mati√®res</div>
        <ul class="toc-list">
          {tocItems.map(item => (
            <li class={`toc-item toc-level-${item.level}`}>
              <a href={`#${item.slug}`} class="toc-link">{item.text}</a>
            </li>
          ))}
        </ul>
      </nav>
    </aside>

    <!-- Article Content -->
    <article class="article-content">
      <!-- Header -->
      <header class="mb-12">
        <div class="flex items-center gap-2 mb-4">
          {article.tags.map(tag => (
            <span class="text-xs font-mono px-2 py-1 rounded bg-[var(--color-bg-alt)] text-[var(--color-accent)]">
              {tag}
            </span>
          ))}
        </div>
        
        <div class="flex items-center gap-4 text-sm text-[var(--color-text-muted)] font-mono">
          <span>{formattedDate}</span>
          <span>‚Ä¢</span>
          <span>{article.readingTime} de lecture</span>
        </div>
      </header>
      
      <!-- Content Before Diagram -->
      <div class="prose-article" set:html={htmlBefore} />
      
      <!-- Diagram -->
      <IDORMethodDiagram />
      
      <!-- Content After Diagram -->
      {htmlAfter && <div class="prose-article" set:html={htmlAfter} />}
      
      <!-- Back link -->
      <div class="mt-12 pt-8 border-t border-[var(--color-border)]">
        <a href="/articles" class="text-[var(--color-text-muted)] hover:text-[var(--color-accent)] font-mono text-sm">
          ‚Üê Retour aux articles
        </a>
      </div>
    </article>
  </div>
</Layout>

<style>
  .article-layout {
    position: relative;
  }

  .toc-sidebar {
    display: none;
  }

  @media (min-width: 1280px) {
    .toc-sidebar {
      display: block;
      position: fixed;
      left: 1rem;
      top: 6rem;
      width: 220px;
      max-height: calc(100vh - 8rem);
      overflow-y: auto;
      padding: 1rem;
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 0.5rem;
    }
  }

  @media (min-width: 1536px) {
    .toc-sidebar {
      left: 2rem;
      width: 250px;
    }
  }

  .toc-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
    font-family: monospace;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 0.5rem;
  }

  .toc-level-3 {
    padding-left: 1rem;
  }

  .toc-link {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    text-decoration: none;
    display: block;
    padding: 0.25rem 0;
    border-left: 2px solid transparent;
    padding-left: 0.75rem;
    transition: all 0.15s ease;
  }

  .toc-link:hover {
    color: var(--color-accent);
    border-left-color: var(--color-accent);
  }

  .article-content {
    min-width: 0;
  }
</style>

<style is:global>
  .prose-article {
    color: var(--color-text);
  }
  
  .prose-article h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--color-text);
  }
  
  .prose-article h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: var(--color-text);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 0.5rem;
    scroll-margin-top: 2rem;
  }
  
  .prose-article h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: var(--color-text);
    scroll-margin-top: 2rem;
  }
  
  .prose-article h4 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--color-text);
  }
  
  .prose-article p {
    margin-bottom: 1rem;
    color: var(--color-text-muted);
    line-height: 1.75;
  }
  
  .prose-article blockquote {
    border-left: 4px solid var(--color-accent);
    padding-left: 1rem;
    font-style: italic;
    color: var(--color-text-muted);
    margin: 1.5rem 0;
  }
  
  .prose-article ul, .prose-article ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }
  
  .prose-article li {
    margin-bottom: 0.5rem;
    color: var(--color-text-muted);
    line-height: 1.75;
  }
  
  .prose-article code {
    background: var(--color-bg-alt);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    color: var(--color-accent);
    font-family: monospace;
    font-size: 0.875rem;
  }
  
  .prose-article pre {
    background: var(--color-bg-alt);
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    border: 1px solid var(--color-border);
  }
  
  .prose-article pre code {
    background: transparent;
    padding: 0;
    color: var(--color-text);
    font-size: 0.875rem;
    line-height: 1.5;
  }
  
  .prose-article table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
  }
  
  .prose-article th {
    text-align: left;
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text);
    font-weight: 600;
    background: var(--color-bg-alt);
  }
  
  .prose-article td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text-muted);
  }
  
  .prose-article a {
    color: var(--color-accent);
  }
  
  .prose-article a:hover {
    text-decoration: underline;
  }
  
  .prose-article hr {
    margin: 2.5rem 0;
    border-color: var(--color-border);
  }
  
  .prose-article strong {
    color: var(--color-text);
    font-weight: 600;
  }
  
  .prose-article em {
    font-style: italic;
  }

  /* Callout boxes */
  .callout {
    margin: 1.5rem 0;
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    border-left: 4px solid;
  }

  .callout-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .callout-content p {
    margin-bottom: 0.5rem;
  }

  .callout-content p:last-child {
    margin-bottom: 0;
  }

  .callout-tip {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgb(34, 197, 94);
  }

  .callout-tip .callout-title {
    color: rgb(34, 197, 94);
  }

  .callout-warning {
    background: rgba(234, 179, 8, 0.1);
    border-color: rgb(234, 179, 8);
  }

  .callout-warning .callout-title {
    color: rgb(234, 179, 8);
  }

  .callout-info {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgb(59, 130, 246);
  }

  .callout-info .callout-title {
    color: rgb(59, 130, 246);
  }

  .callout-note {
    background: rgba(168, 85, 247, 0.1);
    border-color: rgb(168, 85, 247);
  }

  .callout-note .callout-title {
    color: rgb(168, 85, 247);
  }
</style>

<script>
  // Highlight current section in TOC
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('.prose-article h2, .prose-article h3');
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, { rootMargin: '-20% 0px -80% 0px' });
    
    headings.forEach(heading => observer.observe(heading));
  });
</script>

<style is:global>
  .toc-link.active {
    color: var(--color-accent);
    border-left-color: var(--color-accent);
  }
</style>
